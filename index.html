<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Blast: Heroes Arcade</title>
    <style>
        :root {
            --bg-color: #171c3a; 
            --grid-bg: #0f132a;
            --cell-empty: #1c2340;
            --gap: 4px;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; font-family: 'Segoe UI', sans-serif; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: white;
            display: flex; flex-direction: column; align-items: center;
            height: 100dvh; overflow: hidden;
        }

        /* --- UI ATAS --- */
        .top-bar {
            width: 100%; max-width: 450px; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .user-profile { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .user-img { width: 35px; height: 35px; border-radius: 50%; background: #ddd; object-fit: cover; }
        .btn-small {
            background: #2563eb; color: white; border: none; padding: 5px 12px;
            border-radius: 15px; font-size: 0.8rem; cursor: pointer;
        }

        .score-board { text-align: center; margin-bottom: 10px; }
        .score-val { font-size: 3rem; font-weight: 800; text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); }
        .best-val { color: #fbbf24; font-size: 1rem; font-weight: bold; }

        /* --- PAPAN GAME (BOARD) --- */
        .game-board {
            background-color: var(--grid-bg);
            padding: 10px;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: var(--gap);
            width: 92vw; max-width: 400px;
            aspect-ratio: 1/1;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .cell {
            background-color: var(--cell-empty);
            border-radius: 6px;
            width: 100%; height: 100%;
            /* Fix Bayangan: Inset shadow untuk efek kedalaman */
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.4), inset -1px -1px 2px rgba(255,255,255,0.05);
            position: relative;
        }

        /* Block yang sudah terisi di board */
        .cell.filled {
            background-size: cover;
            background-position: center;
            /* Efek timbul (Outset) untuk block terisi */
            box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.2);
            z-index: 1;
        }

        /* Indikator posisi drop */
        .cell.highlight {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 10px rgba(255,255,255,0.2);
        }

        .cleared { animation: popOut 0.3s forwards; }
        @keyframes popOut { to { transform: scale(0); opacity: 0; } }

        /* --- DOCK & PIECES --- */
        .dock {
            width: 100%; max-width: 400px; height: 140px;
            display: flex; justify-content: space-around; align-items: center;
        }
        .dock-slot { width: 30%; height: 100%; display: flex; justify-content: center; align-items: center; }

        .piece {
            display: grid; gap: 2px;
            transform: scale(0.65); /* Ukuran di dock */
            cursor: grab;
            transition: transform 0.1s;
        }

        .piece-block {
            width: 38px; height: 38px; /* Ukuran dasar blok */
            border-radius: 4px;
            background-size: cover;
            box-shadow: 0 2px 2px rgba(0,0,0,0.3);
        }

        /* Saat di-drag */
        .piece.dragging {
            position: fixed;
            z-index: 9999;
            pointer-events: none; /* Tembus sentuhan agar bisa deteksi elemen bawahnya */
            transform: scale(1) !important; /* Ukuran asli saat di drag */
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
            opacity: 0.95;
        }

        /* --- LEADERBOARD & MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 10000;
        }
        .modal-content {
            background: #1e293b; padding: 25px; border-radius: 15px;
            width: 90%; max-width: 350px; text-align: center;
            border: 1px solid #334155;
        }
        .rank-list {
            text-align: left; max-height: 250px; overflow-y: auto;
            margin: 15px 0; background: #0f172a; padding: 10px; border-radius: 8px;
        }
        .rank-item {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px solid #334155; font-size: 0.9rem;
        }
        .rank-item:last-child { border: none; }
        .rank-name { color: #94a3b8; }
        .rank-score { color: #fbbf24; font-weight: bold; }
        
        .btn-primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white; border: none; padding: 12px 30px;
            border-radius: 50px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="user-profile" id="auth-section">
            <button class="btn-small" onclick="signIn()">Login G+</button>
        </div>
        <div class="user-profile" id="user-info" style="display:none;">
            <img src="" id="user-pic" class="user-img">
            <span id="user-name">Player</span>
        </div>
        <button class="btn-small" style="background:#4f46e5" onclick="showLeaderboard()">üèÜ Rank</button>
    </div>

    <div class="score-board">
        <div class="best-val">BEST: <span id="best-score">0</span></div>
        <div class="score-val" id="score">0</div>
    </div>

    <div class="game-board" id="grid"></div>

    <div class="dock" id="dock">
        <div class="dock-slot" id="slot-0"></div>
        <div class="dock-slot" id="slot-1"></div>
        <div class="dock-slot" id="slot-2"></div>
    </div>

    <div class="modal-overlay" id="modal-gameover">
        <div class="modal-content">
            <h2 style="color:#ef4444; margin:0;">GAME OVER</h2>
            <p style="color:#94a3b8;">Score Kamu</p>
            <div style="font-size: 2.5rem; font-weight:bold; color:white; margin-bottom:20px;" id="final-score">0</div>
            <button class="btn-primary" onclick="resetGame()">Main Lagi</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-leaderboard">
        <div class="modal-content">
            <h3>üèÜ Top Players</h3>
            <div class="rank-list" id="rank-list">
                <div style="text-align:center; color:#64748b;">Loading...</div>
            </div>
            <button class="btn-small" onclick="document.getElementById('modal-leaderboard').style.display='none'">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- 1. KONFIGURASI FIREBASE ANDA DISINI ---
        const firebaseConfig = {
  apiKey: "AIzaSyAF1M_h7A2_2Xacxb2qJw7jX5brhat4CGA",
  authDomain: "free-b852f.firebaseapp.com",
  databaseURL: "https://free-b852f-default-rtdb.firebaseio.com",
  projectId: "free-b852f",
  storageBucket: "free-b852f.firebasestorage.app",
  messagingSenderId: "636007240374",
  appId: "1:636007240374:web:075539b483bf199e1ccc17",
  measurementId: "G-6EC7QW1145"
};

        // Initialize Firebase
        let app, auth, db, user;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) {
            console.error("Firebase belum disetting!", e);
        }

        // --- AUTH LOGIC ---
        window.signIn = () => {
            if(!auth) return alert("Firebase Config belum diisi!");
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => alert(err.message));
        }

        if(auth) {
            onAuthStateChanged(auth, (u) => {
                if (u) {
                    user = u;
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('user-info').style.display = 'flex';
                    document.getElementById('user-name').innerText = u.displayName.split(' ')[0];
                    document.getElementById('user-pic').src = u.photoURL;
                    saveUserData(u); // Simpan data user basic
                }
            });
        }

        async function saveUserData(u) {
            // Update data user di database untuk keperluan ranking
            try {
                await setDoc(doc(db, "users", u.uid), {
                    name: u.displayName,
                    photo: u.photoURL,
                    lastLogin: Date.now()
                }, { merge: true });
            } catch(e) { console.log("Error save user", e); }
        }

        async function saveScore(finalScore) {
            if(!user || !db) return;
            try {
                // Simpan score ke koleksi 'leaderboard'
                await addDoc(collection(db, "leaderboard"), {
                    uid: user.uid,
                    name: user.displayName,
                    score: finalScore,
                    date: Date.now()
                });
            } catch(e) { console.error("Gagal simpan score", e); }
        }

        window.showLeaderboard = async () => {
            if(!db) return alert("Firebase belum aktif");
            document.getElementById('modal-leaderboard').style.display = 'flex';
            const listEl = document.getElementById('rank-list');
            listEl.innerHTML = '<div style="text-align:center;">Loading...</div>';

            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                let html = '';
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let color = rank === 1 ? '#fbbf24' : (rank === 2 ? '#94a3b8' : (rank === 3 ? '#b45309' : '#64748b'));
                    html += `
                        <div class="rank-item">
                            <span style="color:${color}; width:20px; font-weight:bold;">#${rank}</span>
                            <span class="rank-name">${data.name.substring(0, 15)}</span>
                            <span class="rank-score">${data.score}</span>
                        </div>
                    `;
                    rank++;
                });
                listEl.innerHTML = html || '<div style="text-align:center;">Belum ada data</div>';
            } catch(e) {
                listEl.innerHTML = 'Error loading data.';
                console.error(e);
            }
        }

        // --- GAME LOGIC START ---
        const GRID_SIZE = 8;
        const ASSETS = [
            'https://res.cloudinary.com/dsutaioqw/image/upload/v1770908103/block1_rgsmm5.png',
            'https://res.cloudinary.com/dsutaioqw/image/upload/v1770908103/block2_bctdq8.png',
            'https://res.cloudinary.com/dsutaioqw/image/upload/v1770908103/block3_lt4n75.png',
            'https://res.cloudinary.com/dsutaioqw/image/upload/v1770908102/block4_h3yano.png',
            'https://res.cloudinary.com/dsutaioqw/image/upload/v1770908103/block5_d0pye8.png'
        ];

        // Definisikan warna fallback agar background tidak transparan
        const COLORS = {
            'block1': '#e91e63', 'block2': '#2196f3', 'block3': '#4caf50', 
            'block4': '#ff9800', 'block5': '#9c27b0'
        };

        const SHAPES = [
            { m: [[1]], id: '1' }, { m: [[1,1]], id: '2h' }, { m: [[1],[1]], id: '2v' },
            { m: [[1,1,1]], id: '3h' }, { m: [[1],[1],[1]], id: '3v' },
            { m: [[1,1],[1,1]], id: 'sq' }, { m: [[1,0],[1,1]], id: 'L1' },
            { m: [[1,1,1],[0,1,0]], id: 'T' }, { m: [[1,1,1,1]], id: '4h' }
        ];

        let grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(null));
        let score = 0;
        let bestScore = localStorage.getItem('blockBlastBest') || 0;
        document.getElementById('best-score').innerText = bestScore;

        const gridEl = document.getElementById('grid');

        function initGrid() {
            gridEl.innerHTML = '';
            for(let r=0; r<GRID_SIZE; r++) {
                for(let c=0; c<GRID_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    gridEl.appendChild(cell);
                }
            }
        }

        window.spawnPieces = function() {
            [0, 1, 2].forEach(i => {
                const slot = document.getElementById(`slot-${i}`);
                if (slot.childElementCount === 0) {
                    const shape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
                    const imgUrl = ASSETS[Math.floor(Math.random() * ASSETS.length)];
                    createPiece(slot, shape.m, imgUrl);
                }
            });
            checkGameOver();
        }

        function getColorFromUrl(url) {
            for(let key in COLORS) { if(url.includes(key)) return COLORS[key]; }
            return '#666';
        }

        function createPiece(container, matrix, texture) {
            const piece = document.createElement('div');
            piece.classList.add('piece');
            piece.style.gridTemplateColumns = `repeat(${matrix[0].length}, 1fr)`;
            piece.dataset.matrix = JSON.stringify(matrix);
            piece.dataset.texture = texture;
            piece.dataset.color = getColorFromUrl(texture); // Simpan warna

            matrix.forEach(row => {
                row.forEach(val => {
                    const block = document.createElement('div');
                    if (val) {
                        block.classList.add('piece-block');
                        block.style.backgroundImage = `url('${texture}')`;
                        block.style.backgroundColor = piece.dataset.color; // Pastikan warna dasar ada
                    } else {
                        block.style.width = '38px'; block.style.height = '38px'; block.style.visibility = 'hidden';
                    }
                    piece.appendChild(block);
                });
            });

            // Touch & Mouse Events
            piece.addEventListener('mousedown', startDrag);
            piece.addEventListener('touchstart', startDrag, {passive: false});
            container.appendChild(piece);
        }

        // --- DRAG LOGIC (REVISED FOR PRECISION) ---
        let dragged = null;
        let startParent = null;
        let matrix = null;
        let texture = null;
        let baseColor = null;

        function startDrag(e) {
            e.preventDefault();
            dragged = e.currentTarget;
            startParent = dragged.parentElement;
            matrix = JSON.parse(dragged.dataset.matrix);
            texture = dragged.dataset.texture;
            baseColor = dragged.dataset.color;

            dragged.classList.add('dragging');
            document.body.appendChild(dragged);

            updatePosition(e);

            document.addEventListener('mousemove', moveDrag);
            document.addEventListener('touchmove', moveDrag, {passive: false});
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function moveDrag(e) {
            e.preventDefault();
            updatePosition(e);
            
            // Highlight Logic
            const {r, c} = getGridPos(e);
            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            
            if (r !== null && canPlace(r, c, matrix)) {
                showHighlight(r, c, matrix);
            }
        }

        function updatePosition(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // FIX PRESISI:
            // 1. Ambil lebar piece
            const rect = dragged.getBoundingClientRect();
            // 2. Set posisi horizontal tepat di tengah jari
            dragged.style.left = (clientX - (rect.width / 2)) + 'px';
            // 3. Set posisi vertikal DI ATAS jari (offset -80px) agar tidak tertutup tangan
            dragged.style.top = (clientY - rect.height - 50) + 'px'; 
        }

        function getGridPos(e) {
            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            
            // Kita cek elemen yang ada DI BAWAH offset visual piece
            // Karena piece kita angkat 50px-80px ke atas, kita harus "nembak" ke lokasi itu
            const targetEl = document.elementFromPoint(clientX, clientY - 80);
            
            if (targetEl && targetEl.classList.contains('cell')) {
                return { r: parseInt(targetEl.dataset.r), c: parseInt(targetEl.dataset.c) };
            }
            return { r: null, c: null };
        }

        function endDrag(e) {
            const {r, c} = getGridPos(e);
            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));

            if (r !== null && canPlace(r, c, matrix)) {
                placePiece(r, c, matrix, texture, baseColor);
                dragged.remove();
                
                // Score
                score += matrix.flat().filter(x=>x).length * 10;
                checkLines();
                document.getElementById('score').innerText = score;
                spawnPieces();
            } else {
                // Return to dock
                dragged.classList.remove('dragging');
                dragged.style.position = '';
                dragged.style.left = ''; dragged.style.top = '';
                dragged.style.transform = ''; // Reset scale
                startParent.appendChild(dragged);
            }

            dragged = null;
            document.removeEventListener('mousemove', moveDrag);
            document.removeEventListener('touchmove', moveDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
        }

        // --- GRID LOGIC ---
        function canPlace(sr, sc, m) {
            for(let r=0; r<m.length; r++) {
                for(let c=0; c<m[0].length; c++) {
                    if(m[r][c]) {
                        if(sr+r >= GRID_SIZE || sc+c >= GRID_SIZE) return false;
                        if(grid[sr+r][sc+c] !== null) return false;
                    }
                }
            }
            return true;
        }

        function showHighlight(sr, sc, m) {
            for(let r=0; r<m.length; r++) {
                for(let c=0; c<m[0].length; c++) {
                    if(m[r][c]) {
                        const cell = document.querySelector(`.cell[data-r="${sr+r}"][data-c="${sc+c}"]`);
                        if(cell) cell.classList.add('highlight');
                    }
                }
            }
        }

        function placePiece(sr, sc, m, tex, col) {
            for(let r=0; r<m.length; r++) {
                for(let c=0; c<m[0].length; c++) {
                    if(m[r][c]) {
                        grid[sr+r][sc+c] = 1;
                        const cell = document.querySelector(`.cell[data-r="${sr+r}"][data-c="${sc+c}"]`);
                        cell.classList.add('filled');
                        cell.style.backgroundImage = `url('${tex}')`;
                        // FIX TRANSPARANSI: Set background color eksplisit
                        cell.style.backgroundColor = col; 
                    }
                }
            }
        }

        function checkLines() {
            let rows = [], cols = [];
            for(let r=0; r<GRID_SIZE; r++) { if(grid[r].every(v => v !== null)) rows.push(r); }
            for(let c=0; c<GRID_SIZE; c++) { 
                let full = true;
                for(let r=0; r<GRID_SIZE; r++) if(grid[r][c] === null) full = false;
                if(full) cols.push(c);
            }

            let cleared = new Set();
            rows.forEach(r => { for(let c=0; c<GRID_SIZE; c++) cleared.add(`${r},${c}`); });
            cols.forEach(c => { for(let r=0; r<GRID_SIZE; r++) cleared.add(`${r},${c}`); });

            if (cleared.size > 0) {
                // Combo Bonus
                let multiplier = rows.length + cols.length;
                score += (cleared.size * 10) * multiplier;
                document.getElementById('score').innerText = score;

                cleared.forEach(coord => {
                    const [r, c] = coord.split(',');
                    grid[r][c] = null;
                    const cell = document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
                    cell.classList.add('cleared');
                    setTimeout(() => {
                        cell.classList.remove('filled', 'cleared');
                        cell.style.backgroundImage = '';
                        cell.style.backgroundColor = ''; // Reset color
                    }, 300);
                });
            }
        }

        function checkGameOver() {
            const slots = document.querySelectorAll('.dock-slot .piece');
            if(slots.length === 0) return;

            let possible = false;
            slots.forEach(p => {
                const m = JSON.parse(p.dataset.matrix);
                for(let r=0; r<GRID_SIZE; r++) {
                    for(let c=0; c<GRID_SIZE; c++) {
                        if(canPlace(r, c, m)) possible = true;
                    }
                }
            });

            if(!possible) {
                setTimeout(() => {
                    document.getElementById('modal-gameover').style.display = 'flex';
                    document.getElementById('final-score').innerText = score;
                    if(score > bestScore) {
                        localStorage.setItem('blockBlastBest', score);
                        bestScore = score;
                    }
                    if(user) saveScore(score); // Simpan ke leaderboard jika login
                }, 1000);
            }
        }

        window.resetGame = function() {
            score = 0;
            document.getElementById('score').innerText = '0';
            grid = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(null));
            initGrid();
            document.getElementById('dock').innerHTML = `
                <div class="dock-slot" id="slot-0"></div>
                <div class="dock-slot" id="slot-1"></div>
                <div class="dock-slot" id="slot-2"></div>
            `;
            document.getElementById('modal-gameover').style.display = 'none';
            spawnPieces();
        }

        // Init
        initGrid();
        spawnPieces();

    </script>
</body>
</html>
